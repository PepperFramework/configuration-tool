@page "/manage-questions"
@using System.ComponentModel.DataAnnotations
@using Blazored.LocalStorage
@using ConfigurationTool.Utils
@using ConfigurationTool.Components
@using ConfigurationTool.Model
@attribute [Authorize]
@inject IStringLocalizer<ApplicationResource> Localizer
@inject ILocalStorageService Localstorage
@inject NavigationManager Navigation

<PageTitle>@Localizer["QuestionsManagement"]</PageTitle>
<MudText Typo="Typo.h3" GutterBottom="true">@Localizer["QuestionsManagement"]</MudText>

<EditForm Model="@model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator/>
    <MudCard>
        <MudCardContent>
            <MudTextField Label=@Localizer["Question"] @bind-Value="model.Text" For="@(() => model.Text)" />
            @foreach (var answer in model.Answers)
            {
                <MudTextField Label=@Localizer["Answer"] @bind-Value="answer.Text" For="@(() => answer.Text)"/>
            }
        </MudCardContent>
        <MudCardActions>
            <MudButton Color="Color.Info" OnClick="() => AddAnswer()">Add answer</MudButton>
            <MudButton ButtonType="ButtonType.Reset" Color="Color.Error">Reset</MudButton>
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Register</MudButton>
        </MudCardActions>
    </MudCard>
</EditForm>
<h3>@Localizer["QuestionListTitle"]</h3>
@if (_questions != null)
{
    <QuestionList Questions="@_questions"></QuestionList>
}


@code {
    List<Question>? _questions;
    
    protected override async Task OnInitializedAsync()
    {
        var jwt = await CheckJwt();
        _questions = await HttpUtils.Get<List<Question>>("question", jwtToken: jwt);
    }

    private async void OnValidSubmit(EditContext context)
    {
        var jwt = await CheckJwt();
        Console.WriteLine("Submitting question");
        var question = await HttpUtils.Post<CreateQuestion>("question", model, jwtToken: jwt);
        _questions = await HttpUtils.Get<List<Question>>("question", jwtToken: jwt);
        Console.WriteLine(question);
        StateHasChanged();
    }

    private CreateQuestion model = new()
    {
        Text = "",
        Answers = new List<CreateAnswer>()
        {
            new()
            {
                User = "NOT IMPLEMENTED",
            }
        }
    };

    private void AddAnswer()
    {
        model.Answers.Add(new CreateAnswer()
        {
            User = "NOT IMPLEMENTED",
        });
    }

    private class CreateQuestion
    {
        [Required] public string Text { get; set; }
        public List<CreateAnswer> Answers { get; set; }
    }

    public class CreateAnswer
    {
        [Required]
        [StringLength(10, ErrorMessage = "The answer text must be at least 10 characters long.")]
        public string? Text { get; set; }

        public string? User { get; set; }
    }

    private async Task<string> CheckJwt()
    {
        var token = await Localstorage.GetItemAsync<string>("token");
        if (token != null) return token;

        await Localstorage.RemoveItemAsync("token");
        Navigation.NavigateTo("/login");
        return "";
    }

}